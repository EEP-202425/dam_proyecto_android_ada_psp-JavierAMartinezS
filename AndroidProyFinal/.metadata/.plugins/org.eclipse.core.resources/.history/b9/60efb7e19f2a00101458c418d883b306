package adapspand.proyfinal.ruta;

import java.util.ArrayList;
import java.util.List;

import adapspand.proyfinal.billete.Billete;
import adapspand.proyfinal.linea.Linea;
import adapspand.proyfinal.parada.Estaciones;
import adapspand.proyfinal.parada.Parada;
import adapspand.proyfinal.tren.Tren;
import jakarta.persistence.CascadeType;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.JoinTable;
import jakarta.persistence.ManyToMany;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.OneToMany;
import jakarta.persistence.OneToOne;
import jakarta.persistence.Table;

@Entity
@Table(name = "ruta")
public class Ruta {
	
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id;
	
	@ManyToOne
    @JoinColumn(name = "origenId")
	private Parada origen;
	
	@ManyToOne
    @JoinColumn(name = "destino_id")
	private Parada destino;
	
	@ManyToOne
	@JoinColumn(name = "RecorridoId")
	private List<Parada> recorrido;
	
	@ManyToMany
	@JoinTable(
		    name = "LineasEnRuta",
		    joinColumns = @JoinColumn(name = "rutaIdEnLinea"),
		    inverseJoinColumns = @JoinColumn(name = "lineaIdEnRuta")
		)
	private List<Linea> lineasUsadas = new ArrayList<>();
	
	private boolean transbordo = false;
	
	@OneToMany(mappedBy = "rutaCorrespondiente")
	private List<Tren> trenes = new ArrayList<>();
	
	@OneToOne(mappedBy = "billete", cascade = CascadeType.ALL)
	private Billete billete;

	public Ruta() {
		super();
	}

	public Ruta(Long id, Parada origen, Parada destino, List<Parada> recorrido) {
		super();
		this.id = id;
		this.origen = origen;
		this.destino = destino;
		this.recorrido = recorrido;
	}
	
	private List<List<Estaciones>> obtenerTodasLasLineas() {
	    List<List<Estaciones>> lineas = new ArrayList<>();
	    
	    lineas.add(Linea.setLineaA());
	    lineas.add(Linea.setLineaB());
	    lineas.add(Linea.setLineaC());
	    lineas.add(Linea.setLineaD());
	    lineas.add(Linea.setLineaE());
	    
	    return lineas;
	}

	
	public Ruta getRuta(Parada origen, Parada destino) {
	    List<Parada> mejorRuta = new ArrayList<>();
	    boolean rutaEncontrada = false;

	    // Obtienes todas las líneas disponibles
	    List<List<Estaciones>> lineas = obtenerTodasLasLineas();

	    for (List<Estaciones> linea : lineas) {
	        for (int i = 0; i < linea.size(); i++) {
	            // Compara las paradas de la línea con las de la ruta
	            if (linea.get(i) == origen.getNombre()) {
	                // Encuentra el origen y empieza a construir la ruta
	                for (int j = i; j < linea.size(); j++) {
	                    if (linea.get(j) == destino.getNombre()) {
	                        // Si encuentras el destino, añades todas las paradas intermedias
	                        for (int k = i; k <= j; k++) {
	                            Parada parada = new Parada(); // Crear una nueva parada
	                            parada.setNombre(linea.get(k)); // Asignar el valor del Enum
	                            
	                            // Marcar las paradas de cambio de línea, origen y destino
	                            if (k == i) parada.setEsOrigen(true);  // Marca la parada de origen
	                            if (k == j) parada.setEsDestino(true); // Marca la parada de destino
	                            if (k != i && k != j) parada.setEsIntermedio(true); // Marca las paradas intermedias
	                            
	                            // Añadir la parada a la ruta
	                            mejorRuta.add(parada);
	                        }
	                        rutaEncontrada = true;
	                        break;
	                    }
	                }
	            }
	            if (rutaEncontrada) break;
	        }
	        if (rutaEncontrada) break;
	    }

	    // Crear el objeto Ruta con el recorrido calculado
	    Ruta ruta = new Ruta();
	    ruta.setOrigen(origen);
	    ruta.setDestino(destino);
	    ruta.setRecorrido(mejorRuta); // Establecer las paradas calculadas en el recorrido

	    return ruta; // Devolver la ruta con el recorrido
	}

	
}
